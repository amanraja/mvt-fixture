# mvt-fixtures

[![Build Status](https://travis-ci.org/mapbox/mvt-fixtures.svg?branch=master)](https://travis-ci.org/mapbox/mvt-fixtures)

A `require()`able suite of valid and invalid vector tile fixtures for testing [Mapbox Vector Tile](https://github.com/mapbox/vector-tile-spec) encoders and decoders. You can view a list of all fixtures at [FIXTURES.md](FIXTURES.md).

# Usage

mvt-fixtures can be used in two distinct ways

1. **javascript interface**: use the javascript interface to generate fixtures on the fly
1. **raw fixtures** use the raw fixtures directly via the /fixtures directory.

The Javascript API is recommended if you are working in Javascript or Node.js. The raw fixtures are provided for those using this outside of a Javascript application. The recommended workflow is to have your encoder or decoder loop through every fixture and either expect to successfully decode/encode valid fixtures, or fail to decode/encode invalid fixtures. When new fixtures are added to this repository, you simply need to update the version of the module (or your submodule) to get the new fixtures and re-run tests.

**Validity:** each fixture includes information about whether they are valid according to the specification versions and possible error outcomes if they are invalid. If any of the fixtures are invalid, they must include an `error` field describing how to recover (or not) from the error. These can be found in the `validity` field of the fixture and info.json files. The following checks:

* `v1` (Boolean): is this fixture valid according to Version 1.x of the Mapbox Vector Tile spec
* `v2` (Boolean): is this fixture valid according to Version 2.x of the Mapbox Vector Tile spec
* `error` (String): describes if the encoder/decoder should recover from this error or stop completely. THis is only present if the fixture is invalid according to one or more spec revisions. Values are
  * `recoverable`: should the encoder/decoder continue move on and continue its work? For instance, if invalid geometry is found, can the encoder safely move to the next feature?
  * `fatal`: the encoder should completely stop its process

### Javascript usage

Check out the full Javascript interface over at [API.md](API.md)

```shell
npm install @mapbox/mvt-fixtures --save-dev
```

```javascript
const mvtf = require('@mapbox/mvt-fixtures');
const decoder = require('your-mvt-decoder');

mvtf.each(function(fixture) {
  let output = decoder(fixture.buffer);
  assert.equal(output.layers.length, fixture.json.layers.length, 'expected number of layers');
  // ... more tests
});
```

### Non-JS interface

You can access all of the fixtures and their metadata in the /fixtures directory. You can download this repository and get them manually, or use this repository as a submodule. Each fixture is named by the directory /fixtures/{name} and has the following files:

1. tile.mvt - the protocol buffer that represents (or intentionally breaks) the Mapbox Vector Tile specification
1. tile.json - a JSON representation of the tile and its properties
1. info.json - information about the fixture including `name`, `description`, and `specification_reference`.

# Develop

### Adding a new fixture

All fixtures have a source file in the /src directory. This file is a module that exports an object with the following parameters:

```javascript
module.exports = function(schema) {
  return {
    description: 'DESCRIPTION',
    specification_reference: 'SPECIFICATION_URL',
    validity: {
      v1: true,
      v2: false,
      error: 'ERROR_TYPE'
    },
    json: {...},
    manipulate: function(buffer) {
      // function to further manipulate the buffer
      return buffer;
    }
  }
};
```

A new fixture can be created by running the command, which will auto-increment the ID:

```shell
npm run new
# New file created: /src/003.js.
```

### Building fixtures

To rebuild all of the raw fixtures (including the tile.mvt, tile.json, and info.json files) in /fixtures you can run:

```
npm run build
```

### Building docs

Documentation takes two forms...

1. Javascript API docs in API.md
1. Fixture reference in FIXTURES.md

These can be generated by running:

```
npm run docs
```

### Running tests

All tests can be run with:

```
npm test
```
